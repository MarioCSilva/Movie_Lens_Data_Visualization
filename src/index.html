<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
        integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
    <script type="text/javascript" src="http://d3js.org/d3.v6.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.slim.js"
        integrity="sha256-HwWONEZrpuoh951cQD1ov2HUK5zA5DwJ1DNUXaM6FsY=" crossorigin="anonymous"></script>
    <link href="css/select2.min.css" rel="stylesheet" />
    <script src="js/select2.min.js"></script>
    <script src="./js/cloud.js"></script>
    <link rel="stylesheet" href="css/rSlider.min.css">
    <script src="js/rSlider.min.js"></script>
    <link rel="stylesheet" href="css/mystyle.css">
    <link rel="stylesheet" href="css/legend.css">
    <title>MovieLens Data Visualization</title>
</head>

<body>

    <div class="sidenav">
        <h1>VISUALIZATIONS</h1>
        <span><a class="effect-1" href="#barchart_genres"><i class='fas fa-caret-right'></i> Number of
                Ratings</a></span>
        <span><a class="effect-1" href="#lineplot_num"><i class='fas fa-caret-right'></i> Number of Ratings
                Evolution</a></span>
        <span><a class="effect-1" href="#box_plot_popularity"><i class='fas fa-caret-right'></i> Average Ratings
                Distribution</a></span>
        <span><a class="effect-1" href="#lineplot_avg"><i class='fas fa-caret-right'></i> Average Ratings
                Evolution</a></span>
        <span><a class="effect-1" href="#scatter_movies"><i class='fas fa-caret-right'></i> Popularity
                Overview</a></span>
        <span><a class="effect-1" href="#word_cloud_tags"><i class='fas fa-caret-right'></i> Most Common
                Opinions</a></span>

        <hr style="margin: 30px 0px 30px 0px; color: white; border:1px solid #fff">

        <h1 style="padding: 0px 0px 30px 0px">FILTERS</h1>

        <div class="wrapper">
            <input type="radio" name="select" id="option-1" checked onclick="selectChange()">
            <input type="radio" name="select" id="option-2" onclick="selectChange()">
            <label for="option-1" class="option option-1">
                <div class="dot"></div>
                <span>Genres</span>
            </label>
            <label for="option-2" class="option option-2">
                <div class="dot"></div>
                <span>Movies</span>
            </label>
        </div>

        <div id="genreselect" style="display: block;">
            <select class="genre-select" style="width: 100%" multiple="multiple"></select>
        </div>
        <div id="movieselect" style="display: none;">
            <select class="movie-select" id="movieselect" style="width: 100%" multiple="multiple"></select>
        </div>

        <div style="padding: 60px 0px 20px 0px">
            <input type="text" id="slider" class="slider">
        </div>

        <span style="color: white; font-size: 18px; padding:5px 0 10px 0;float:left">Number of Tags</span>
        <div class="range-slider">
            <input class="range-slider__range" id="num_tags" type="range" value="50" min="1" max="300" scale>
            <span class="range-slider__value">50</span>
        </div>

        <div class="box-1">
            <div id="applyfilter" onclick="applyFilters()" class="btn btn-one">
                <span>APPLY FILTERS</span>
            </div>
        </div>
    </div>



    <div class="main">
        <div class="middle" id="loadingIcon">
            <div class="barload barload1"></div>
            <div class="barload barload2"></div>
            <div class="barload barload3"></div>
            <div class="barload barload4"></div>
            <div class="barload barload5"></div>
            <div class="barload barload6"></div>
            <div class="barload barload7"></div>
            <div class="barload barload8"></div>
        </div>

        <h1 style="text-align: center;">Movies & Genres Popularity</h1>

        <div class="legendmain"></div>

        <div id="dataGraphs" style="text-align: center;">
            <div id="barchart_genres" class="singleGraph">
                <h3>Number of Ratings</h3>
            </div>
            <div id="lineplot_num" class="singleGraph">
                <h3>Number of Ratings Evolution</h3>
            </div>
            <div id="box_plot_popularity" class="singleGraph">
                <h3>Ratings Distribuition</h3>
            </div>
            <div id="lineplot_avg" class="singleGraph">
                <h3>Average Ratings Evolution</h3>
            </div>
            <div id="scatter_movies" class="singleGraph">
                <h3>Popularity Overview</h3>
            </div>
            <div id="word_cloud_tags" class="singleGraph">
                <h3>Most Common Opinions</h3>
            </div>
        </div>

    </div>

    <script>
        var max_num_tags = 50;

        var rangeSlider = function () {
            var slider = $('.range-slider'),
                range = $('.range-slider__range'),
                value = $('.range-slider__value');

            slider.each(function () {
                value.each(function () {
                    var value = $(this).prev().attr('value');
                    $(this).html(value);
                });

                range.on('input', function () {
                    $(this).next(value).html(this.value);
                });
            });
        };

        rangeSlider();

        var movie_popularity, genres_review_counter, max_num_reviews, colorScale,
            max_item_num_reviews, min_time, max_time, max_reviews, max_avg_rat, min_avg_rat, filter_max_date, filter_min_date,
            barchart_svg, lineplot_svg_avg, lineplot_svg_num, scatter_svg, box_plot_svg;


        // set the dimensions and margins of the graph
        var margin = { top: 10, right: 30, bottom: 30, left: 60 },
            width = $(window).width() / 1.5 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

        function initGlobalVariables() {
            width = $(window).width() / 1.5 - margin.left - margin.right;
            movie_popularity = {};
            genres_review_counter = {};
            max_num_reviews = 0;
            max_item_num_reviews = 0;
            min_time = new Date();
            max_time = new Date('1750');
            max_reviews = 0;
            max_avg_rat = 0;
            min_avg_rat = 5;

            d3.select("#barchart_genres").select("svg").remove()
            d3.select("#lineplot_num").select("svg").remove()
            d3.select("#lineplot_avg").select("svg").remove()
            d3.select("#scatter_movies").select("svg").remove()
            d3.select("#box_plot_popularity").select("svg").remove()
            d3.select("#word_cloud_tags").select("svg").remove()
            d3.select('.legendmain').select("svg").remove()

            colorScale = d3.scaleOrdinal(
                ['#FF6633', '#FFB399', '#FF33FF', '#1AB399', '#00B3E6',
                    '#E6B333', '#3366E6', '#999966', '#99FF99', '#B34D4D',
                    '#E6B3B3', '#6680B3', '#66991A', '#FF99E6', '#CCFF1A',
                    '#FF1A66', '#E6331A', '#33FFCC', '#B366CC', '#4D8000',
                    '#B33300', '#CC80CC', '#66664D', '#991AFF', '#E666FF',
                    '#E666B3', '#33991A', '#CC9999', '#B3B31A', '#00E680',
                    '#4D8066', '#809980', '#E6FF80', '#1AFF33', '#999933',
                    '#FF3380', '#CCCC00', '#66E64D', '#4D80CC', '#9900B3',
                    '#E64D66', '#4DB380', '#FF4D4D', '#99E6E6', '#6666FF',
                    '#4DB3FF', '#FFFF99'])
                .domain(selected_genres ? selected_genres : selected_movies);

            initLegend()
        }

        function selectChange() {
            if (document.getElementById('genreselect').style.display == 'block') {
                document.getElementById('genreselect').style.display = 'none';
                document.getElementById('movieselect').style.display = 'block';
            } else {
                document.getElementById('genreselect').style.display = 'block';
                document.getElementById('movieselect').style.display = 'none';
            }
        }

        var mySlider = new rSlider({
            target: '#slider',
            values: [1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018],
            set: [1996, 2018],
            labels: false,
            range: true // range slider
        });

        let movies = {};
        let all_genres = new Set();

        let selected_movies = new Set();
        let selected_genres = new Set();

        let barWidth = 30

        // Preprocess movies
        // Uses global variable movies and all_genres
        // dataset: movieId,title,genres
        function preProcessMovies(data) {
            for (let i = 0; i < data.length; i++) {
                genres = data[i].genres.split('|')
                movies[data[i].movieId] = { 'title': data[i].title, 'genres': genres }
                genres.forEach(genre => all_genres.add(genre))
            }
        }

        function drawBoxPlot(items_ratings) {

            var xScale = d3.scalePoint()
                .domain(Object.keys(items_ratings))
                .rangeRound([0, width])
                .padding([0.5]);

            const yScale = d3.scaleLinear()
                .domain([0, 5])
                .range([height, 0]);

            box_plot_svg = d3.select("#box_plot_popularity")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom + 100)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

            var g = box_plot_svg.append("g");

            var verticalLines = g.selectAll(".verticalLines")
                .data(Object.entries(items_ratings))
                .enter()
                .append("line")
                .attr("x1", function (d) { return xScale(d[0]) })
                .attr("y1", function (d) { return yScale(d[1].whiskers[0]); })
                .attr("x2", function (d) { return xScale(d[0]); })
                .attr("y2", function (d) { return yScale(d[1].whiskers[1]); })
                .attr("stroke", "#000")
                .attr("stroke-width", 1)
                .attr("fill", "none");

            box_plot_svg.append("g")
                .attr("transform", "translate(" + -48 + "," + height / 2 + ")")
                .append('text')
                .attr('text-anchor', 'middle')
                .attr('transform', 'rotate(-90)')
                .text("Rating Scale")
                .style("font-size", "15px")

            var rects = g.selectAll("rect")
                .data(Object.entries(items_ratings))
                .enter()
                .append("rect")
                .attr("width", barWidth)
                .attr("height", function (d) {
                    var quartiles = d[1].quartile;
                    var height = yScale(quartiles[0]) - yScale(quartiles[2]);
                    return height;
                })
                .attr("x", function (d) { return xScale(d[0]) - (barWidth / 2); })
                .attr("y", function (d) { return yScale(d[1].quartile[2]); })
                .attr("fill", function (d) { return d[1].color; })
                .attr("stroke", "#000")
                .attr("stroke-width", 1);

            var horizontalLineConfigs = [
                // Top whisker
                {
                    x1: function (d) { return xScale(d[0]) - barWidth / 2 },
                    y1: function (d) { return yScale(d[1].whiskers[0]) },
                    x2: function (d) { return xScale(d[0]) + barWidth / 2 },
                    y2: function (d) { return yScale(d[1].whiskers[0]) }
                },
                // Median line
                {
                    x1: function (d) { return xScale(d[0]) - barWidth / 2 },
                    y1: function (d) { return yScale(d[1].quartile[1]) },
                    x2: function (d) { return xScale(d[0]) + barWidth / 2 },
                    y2: function (d) { return yScale(d[1].quartile[1]) }
                },
                // Bottom whisker
                {
                    x1: function (d) { return xScale(d[0]) - barWidth / 2 },
                    y1: function (d) { return yScale(d[1].whiskers[1]) },
                    x2: function (d) { return xScale(d[0]) + barWidth / 2 },
                    y2: function (d) { return yScale(d[1].whiskers[1]) }
                }
            ];

            for (var i = 0; i < horizontalLineConfigs.length; i++) {
                var lineConfig = horizontalLineConfigs[i];

                var horizontalLine = g.selectAll(".whiskers")
                    .data(Object.entries(items_ratings))
                    .enter()
                    .append("line")
                    .attr("x1", lineConfig.x1)
                    .attr("y1", lineConfig.y1)
                    .attr("x2", lineConfig.x2)
                    .attr("y2", lineConfig.y2)
                    .attr("stroke", "#000")
                    .attr("stroke-width", 1)
                    .attr("fill", "none");
            }

            box_plot_svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(xScale))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            box_plot_svg.append("g")
                .call(d3.axisLeft(yScale));
        }


        function drawScatterPlot(movie_popularity) {
            // Add X axis
            const x = d3.scaleLinear()
                .domain([0, max_num_reviews])
                .range([0, width]);

            scatter_svg = d3.select("#scatter_movies")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom + 15)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

            var xAxis = scatter_svg.append("g")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(x));

            scatter_svg.append("g")
                .attr("transform", "translate(" + (width) / 2 + "," + (height + 40) + ")")
                .append('text')
                .attr('text-anchor', 'middle')
                .text("Number of Ratings")
                .style("font-size", "15px")

            const y = d3.scaleLinear()
                .domain([0, 5])
                .range([height, 0]);

            var yAxis = scatter_svg.append("g")
                .call(d3.axisLeft(y));

            // Set the zoom and Pan features: how much you can zoom, on which part, and what to do when there is a zoom
            var zoom = d3.zoom()
                .scaleExtent([.5, 20])  // This control how much you can unzoom (x0.5) and zoom (x20)
                .extent([[0, 0], [width, height]])
                .on("zoom", (event) => updateChart(event));

            scatter_svg.append("g")
                .attr("transform", "translate(" + -48 + "," + height / 2 + ")")
                .append('text')
                .attr('text-anchor', 'middle')
                .attr('transform', 'rotate(-90)')
                .text("Rating Scale")
                .style("font-size", "15px")
                
            
            // A function that updates the chart when the user zoom and thus new boundaries are available
            function updateChart(event) {
                // recover the new scale
                var newX = event.transform.rescaleX(x);
                var newY = event.transform.rescaleY(y);

                // update axes with these new boundaries
                xAxis.call(d3.axisBottom(newX))
                yAxis.call(d3.axisLeft(newY))

                // update circle position
                scatter_svg
                    .selectAll("circle")
                    .attr('cx', function(d) {return newX(d[1].num_reviews)})
                    .attr('cy', function(d) {return newY(d[1].avg)});
            }

            const tooltip = d3.select("#scatter_movies")
                .append("div")
                .style("opacity", 0)
                .attr("class", "tooltip")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "1px")
                .style("border-radius", "5px")
                .style("padding", "10px")


            // A function that change this tooltip when the user hover a point.
            // Its opacity is set to 1: we can now see it. Plus it set the text and position of tooltip depending on the datapoint (d)
            const mouseover = function (event, d) {
                tooltip
                    .html(`<p style="font-size: 18px; width: 50%; margin:auto">${movies[d[0]].title}</p>
                    <p style="font-size: 18px; width: 50%; margin:auto">Average Rating: ${(d[1].avg).toFixed(2)}</p>
                        <p style="font-size: 18px; width: 50%; margin:auto">Number of Ratings: ${d[1].num_reviews}</p>`)
                    .style("left", (event.x) / 2 + "px")
                    .style("top", (event.y) / 2 + "px")
                    .style("opacity", 1)
            }
            const mouseout = function (event, d) {
                tooltip
                    .style("opacity", 0)
            }
            // A function that change this tooltip when the leaves a point: just need to set opacity to 0 again
            const mouseleave = function (event, d) {
                tooltip
                    .transition()
                    .duration(200)
                    .style("opacity", 0)
            }
              // Add a clipPath: everything out of this area won't be drawn.
            var clip = scatter_svg.append("defs").append("SVG:clipPath")
                .attr("id", "clip")
                .append("SVG:rect")
                .attr("width", width )
                .attr("height", height )
                .attr("x", 0)
                .attr("y", 0);
            // This add an invisible rect on top of the chart area. This rect can recover pointer events: necessary to understand when the user zoom
            scatter_svg.append("rect")
                .attr("width", width)
                .attr("height", height)
                .style("fill", "none")
                .style("pointer-events", "all")
                .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
                .call(zoom)
            // Add dots
            scatter_svg.append('g')
                .attr("clip-path", "url(#clip)")
                .selectAll("dot")
                .data(Object.entries(movie_popularity))
                .join("circle")
                .attr("cx", function (d) { return x(d[1].num_reviews); })
                .attr("cy", function (d) { return y(d[1].avg); })
                .attr("r", function (d) { return (document.getElementById('genreselect').style.display == 'block') ? 2 : 6 })
                .style("fill", function (d) { return (document.getElementById('genreselect').style.display == 'block') ? "#69b3a2" : colorScale(d[0]) })
                .on("mouseover", mouseover)
                .on("mouseout", mouseout)
                .on("mouseleave", mouseleave)

        }


        function parseTimestamp(timestamp, date_obj_format = false) {
            timestamp = parseFloat(timestamp);
            let u = new Date(timestamp * 1000);
            if (date_obj_format) {
                return u;
            }
            let temp = parseFloat(u.getMonth() + 1);
            if (temp < 10) {
                temp = '0' + temp;
            }
            return u.getFullYear() +
                '-' + (temp)
        }



        // dataset: userId,movieId,rating,timestamp
        function preProcessRatings(data) {
            for (let i = 0; i < data.length; i++) {
                movie_id = data[i].movieId
                if (document.getElementById('movieselect').style.display == 'block' && !selected_movies.has(movie_id) ||
                    document.getElementById('genreselect').style.display == 'block' && !movies[movie_id].genres.some(g => selected_genres.has(g))) {
                    continue
                }
                date = parseTimestamp(data[i].timestamp, true);

                if (date < filter_min_date || date > filter_max_date) {
                    continue
                }
                date = parseTimestamp(data[i].timestamp, false);
                if (!movie_popularity[movie_id]) {
                    movie_popularity[movie_id] = {
                        'avg': parseFloat(data[i].rating),
                        'num_reviews': 1,
                        'ratings': [parseFloat(data[i].rating)],
                        'dates': {}
                    }
                    movie_popularity[movie_id].dates[date] = [data[i].rating];
                } else {
                    movie_popularity[movie_id].num_reviews = movie_popularity[movie_id].num_reviews + 1
                    movie_popularity[movie_id].ratings.push(parseFloat(data[i].rating))
                    if (movie_popularity[movie_id].num_reviews > max_num_reviews) {
                        max_num_reviews = movie_popularity[movie_id].num_reviews
                    }
                    if (!movie_popularity[movie_id].dates[date]) {
                        movie_popularity[movie_id].dates[date] = [data[i].rating];
                    } else {
                        movie_popularity[movie_id].dates[date].push(data[i].rating);
                    }

                }

            }
            for (let movie in movie_popularity) {
                ratings = movie_popularity[movie].ratings
                sum = ratings.reduce((a, b) => a + b, 0)
                movie_popularity[movie].avg = sum / ratings.length
            }
            return movie_popularity
        }

        function preProcessItemsPopularity(movie_popularity) {
            let parseTime = d3.timeParse("%Y-%m");

            items_ratings = {}
            if (document.getElementById('genreselect').style.display == 'block') {
                for (let [movie_id, movie_data] of Object.entries(movie_popularity)) {
                    for (let i = 0; i < movies[movie_id].genres.length; i++) {
                        genre = movies[movie_id].genres[i]
                        if (!selected_genres.has(genre)) {
                            continue
                        }
                        if (!items_ratings[genre]) {
                            items_ratings[genre] = { 'ratings': movie_data.ratings.filter(Number), 'reviewstime': {}, 'total_ratings': {} }
                        } else {
                            items_ratings[genre].ratings.push(...movie_data.ratings.filter(Number))
                        }
                        dates = movie_data.dates;
                        for (let date in dates) {
                            all_reviews = dates[date].length;
                            ratings = dates[date]
                            date = parseTime(date);
                            if (max_time < date) {
                                max_time = date;
                            }
                            if (min_time > date) {
                                min_time = date;
                            }
                            if (!items_ratings[genre].reviewstime[date]) {
                                items_ratings[genre].reviewstime[date] = all_reviews;
                            }
                            else {
                                items_ratings[genre].reviewstime[date] += all_reviews
                            }
                            total_rat = ratings.reduce((a, b) => parseFloat(a) + parseFloat(b), 0)
                            if (!items_ratings[genre].total_ratings[date]) {
                                items_ratings[genre].total_ratings[date] = parseFloat(total_rat);
                            } else {
                                items_ratings[genre].total_ratings[date] = parseFloat(items_ratings[genre].total_ratings[date]) + parseFloat(total_rat);
                            }
                        }
                    }
                }
            } else {
                for (let movie_id of selected_movies) {
                    item = movies[movie_id].title
                    dates = movie_popularity[movie_id].dates;
                    items_ratings[item] = { 'ratings': movie_popularity[movie_id].ratings.filter(Number), 'reviewstime': {}, 'total_ratings': {}, 'id': movie_id }
                    for (let date in dates) {
                        all_reviews = dates[date].length;
                        ratings = dates[date]
                        date = parseTime(date);
                        if (max_time < date) {
                            max_time = date;
                        }
                        if (min_time > date) {
                            min_time = date;
                        }
                        if (!items_ratings[item].reviewstime[date]) {
                            items_ratings[item].reviewstime[date] = all_reviews;
                        } else {
                            items_ratings[item].reviewstime[date] += all_reviews
                        }
                        total_rat = ratings.reduce((a, b) => a + b, 0)
                        if (!items_ratings[item].total_ratings[date]) {
                            items_ratings[item].total_ratings[date] = total_rat;
                        } else {
                            items_ratings[item].total_ratings[date] += total_rat;
                        }
                    }
                }
            }

            for (var [item, item_data] of Object.entries(items_ratings)) {
                ratings = item_data.ratings.sort((a, b) => a - b);
                total = 0
                rev_time = Object.entries(item_data.reviewstime)
                tot_rat_time = item_data.total_ratings
                rev_time = rev_time.sort((a, b) => new Date(a[0]) - new Date(b[0]));
                num_ratings = ratings.length
                if (num_ratings > max_item_num_reviews) {
                    max_item_num_reviews = num_ratings;
                }
                for (let i = 0; i < num_ratings; i++) {
                    total += ratings[i]
                }
                localMin = d3.min(ratings);
                localMax = d3.max(ratings);
                obj = {};
                obj["ratings"] = ratings;
                obj["num_ratings"] = num_ratings
                obj["avg_rating"] = total / num_ratings;
                obj["quartile"] = [
                    d3.quantile(ratings, .25),
                    Math.round((obj["avg_rating"] + Number.EPSILON) * 100) / 100,
                    d3.quantile(ratings, .75)
                ]
                obj["whiskers"] = [localMin, localMax];
                obj["color"] = selected_genres.size > 0 ? colorScale(item) : colorScale(item_data.id);

                let last_num_ratings = 0;
                for (let i = 0; i < rev_time.length; i++) {
                    rev_time[i][1] += last_num_ratings
                    last_num_ratings = rev_time[i][1]
                    if (max_reviews < last_num_ratings) {
                        max_reviews = last_num_ratings;
                    }
                }
                let avg_rat_time = []
                let last_total_rating = 0;
                for (let i = 0; i < rev_time.length; i++) {
                    tot_rat_time[rev_time[i][0]] = parseFloat(tot_rat_time[rev_time[i][0]]) + parseFloat(last_total_rating)
                    last_total_rating = tot_rat_time[rev_time[i][0]]
                    avg_rating = tot_rat_time[rev_time[i][0]] / rev_time[i][1]
                    avg_rat_time.push([rev_time[i][0], avg_rating])
                    if (max_avg_rat < avg_rating) {
                        max_avg_rat = avg_rating;
                    }
                    if (min_avg_rat > avg_rating) {
                        min_avg_rat = avg_rating;
                    }
                }
                obj["reviewstime"] = rev_time
                obj["avg_rat_time"] = avg_rat_time
                items_ratings[item] = obj;
            }
            return items_ratings
        }


        function drawBarChart(data) {
            data = Object.entries(data);

            // X axis
            var x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(function (d) { return d[0]; }))
                .padding(0.2);

            barchart_svg = d3.select("#barchart_genres")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom + 100)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

            barchart_svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            // Add Y axis
            var y = d3.scaleLinear()
                .domain([0, max_item_num_reviews])
                .range([height, 0]);

            barchart_svg.append("g")
                .call(d3.axisLeft(y));

            barchart_svg.selectAll("mybar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", function (d) { return x(d[0]); })
                .attr("y", function (d) { return y(d[1].num_ratings); })
                .attr("width", x.bandwidth())
                .attr("height", function (d) { return height - y(d[1].num_ratings); })
                .attr("fill", function (d) { return d[1].color });

            barchart_svg.append("g")
                .attr("transform", "translate(" + -48 + "," + height / 2 + ")")
                .append('text')
                .attr('text-anchor', 'middle')
                .attr('transform', 'rotate(-90)')
                .text("Number of Ratings")
                .style("font-size", "15px")
        }


        function drawWordCloud(tags) {
            fill = d3.scaleOrdinal(d3.schemeCategory10);

            cl_height = parseFloat(height) + margin.bottom + margin.top + parseFloat(max_num_tags) * 0.7
            cl_width = width + margin.left + margin.right
            d3.layout.cloud()
                .size([cl_width, cl_height])
                .words(
                    tags.map(function (tag) {
                        return { text: tag[0], size: tag[1] };
                    }))
                .font("Impact")
                .fontSize(function (tag) {
                    return tag.size;
                })
                .on("end", drawTags)
                .start();

            function drawTags(tags) {
                d3.select("#word_cloud_tags")
                    .append("svg")
                    .attr("width", cl_width)
                    .attr("height", cl_height)
                    .append("g")
                    .attr("transform", "translate(" + [cl_width >> 1, cl_height >> 1] + ")")
                    .selectAll("text")
                    .data(tags)
                    .enter()
                    .append("text")
                    .style("font-size", function (d) { return d.size + "px"; })
                    .style("font-family", "Impact")
                    .attr("text-anchor", "middle")
                    .style("fill", function (d, i) { return fill(i); })
                    .attr("transform", function (d) {
                        return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                    })
                    .text(function (d) { return d.text; });
            }

            d3.layout.cloud().stop();
        }


        function drawLinePlot(data, graph_id) {
            let x = d3.scaleTime()
                .domain([min_time, max_time])
                .range([0, width]);

            lineplot_svg = d3.select(graph_id)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom + 100)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

            lineplot_svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%B %Y")).ticks(10))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            let y = d3.scaleLinear()
                .domain([(graph_id == "#lineplot_num" ? 0 : (min_avg_rat <= 1 ? 0 : min_avg_rat - 0.5)), (graph_id == "#lineplot_num" ? max_reviews : max_avg_rat)])
                .range([height, 0]);

            lineplot_svg.append("g")
                .call(d3.axisLeft(y));

            // Draw the line
            lineplot_svg.selectAll(".line")
                .data(Object.entries(data))
                .enter()
                .append("path")
                .attr("fill", "none")
                .attr("class", "line")
                .attr("stroke", function (d) { return d[1].color; })
                .attr("stroke-width", 1.5)
                .attr("d", function (d) {
                    return d3.line()
                        .x(function (d) { return x(new Date(d[0])); })
                        .y(function (d) { return y(+d[1]); })
                        ((graph_id == "#lineplot_num") ? d[1].reviewstime : d[1].avg_rat_time)
                })
            let label = (graph_id == "#lineplot_num") ? "Number of Ratings" : "Rating Scale"
            lineplot_svg.append("g")
                .attr("transform", "translate(" + -48 + "," + height / 2 + ")")
                .append('text')
                .attr('text-anchor', 'middle')
                .attr('transform', 'rotate(-90)')
                .text(label)
                .style("font-size", "15px")

            var mouseG = lineplot_svg.append("g")
                .attr("class", "mouse-over-effects");

            mouseG.append("path") // this is the black vertical line to follow mouse
                .attr("class", "mouse-line")
                .style("stroke", "black")
                .style("stroke-width", "1px")
                .style("opacity", "0");

            var lines = document.getElementsByClassName('line');
            var mousePerLine = mouseG.selectAll('.mouse-per-line')
                .data(Object.entries(data))
                .enter()
                .append("g")
                .attr("class", "mouse-per-line");

            mousePerLine.append("circle")
                .attr("r", 7)
                .style("stroke", function (d) {
                    return d[1].color;
                })
                .style("fill", "none")
                .style("stroke-width", "1px")
                .style("opacity", "0");

            mousePerLine.append("text")
                .attr("transform", "translate(10,3)");

            mouseG.append('svg:rect') // append a rect to catch mouse movements on canvas
                .attr('width', width) // can't catch mouse events on a g element
                .attr('height', height)
                .attr('fill', 'none')
                .attr('pointer-events', 'all')
                .on('mouseout', function () { // on mouse out hide line, circles and text
                    d3.select(".mouse-line")
                        .style("opacity", "0");
                    d3.selectAll(".mouse-per-line circle")
                        .style("opacity", "0");
                    d3.selectAll(".mouse-per-line text")
                        .style("opacity", "0");
                })
                .on('mouseover', function () { // on mouse in show line, circles and text
                    d3.select(".mouse-line")
                        .style("opacity", "1");
                    d3.selectAll(".mouse-per-line circle")
                        .style("opacity", "1");
                    d3.selectAll(".mouse-per-line text")
                        .style("opacity", "1");
                })
                .on('mousemove', (event) => { // mouse moving over canvas
                    var mouse = d3.pointer(event);
                    d3.select(".mouse-line")
                        .attr("d", function () {
                            var d = "M" + mouse[0] + "," + height;
                            d += " " + mouse[0] + "," + 0;
                            return d;
                        });

                    d3.selectAll(".mouse-per-line")
                        .attr("transform", function (d, i) {
                            var xDate = x.invert(mouse[0]),
                                bisect = d3.bisector(function (d) { return new Date(d[0]); }).right;
                            idx = bisect(d.values, xDate);
                            var beginning = 0,
                                end = lines[i].getTotalLength(),
                                target = null;

                            while (true) {
                                target = Math.floor((beginning + end) / 2);
                                pos = lines[i].getPointAtLength(target);
                                if ((target === end || target === beginning) && pos.x !== mouse[0]) {
                                    break;
                                }
                                if (pos.x > mouse[0]) end = target;
                                else if (pos.x < mouse[0]) beginning = target;
                                else break; //position found
                            }
                            let txt = (graph_id == "#lineplot_num") ? parseInt(y.invert(pos.y)) : y.invert(pos.y).toFixed(2);
                            d3.select(this).select('text')
                                .text(txt)
                                .style('font-size', '10px');
                            return "translate(" + mouse[0] + "," + pos.y + ")";
                        });
                });
        }


        // scale x into a range [a, b]
        function scaleData(a, b, min, max, tags) {
            for (let i = 0; i < tags.length; i++) {
                tags[i][1] = (b - a) * ((tags[i][1] - min) / (max - min)) + a
            }
        }

        // dataset: userId,movieId,tag,timestamp
        function preProcessTags(data) {
            tags = {}
            for (let i = 0; i < data.length; i++) {
                if (document.getElementById('movieselect').style.display == 'block' && !selected_movies.has(data[i].movieId) ||
                    document.getElementById('genreselect').style.display == 'block' && !movies[data[i].movieId].genres.some(g => selected_genres.has(g))) {
                    continue
                }
                if (!tags[data[i].tag.toLowerCase()]) {
                    tags[data[i].tag.toLowerCase()] = 1;
                } else {
                    tags[data[i].tag.toLowerCase()] += 1;
                }
            }

            tags = Object.entries(tags)

            tags.sort(
                (first, second) => { return second[1] - first[1] }
            )
            tags = tags.slice(0, max_num_tags)
            max = tags[0][1]
            min = tags[tags.length - 1][1]
            if (min == max) {
                max += 1
            }
            scaleData(17, 45, min, max + 1, tags)
            return tags
        }


        function addFiltersAndLegend() {
            let elemcounter = 0;
            var movie_data = $.map(Object.entries(movies), function (obj) {
                movie_obj = {}
                if (elemcounter < 5) {
                    selected_movies.add(obj[0])
                    movie_obj.selected = true
                    elemcounter++;
                }
                movie_obj.id = obj[0];
                movie_obj.text = obj[1].title;
                return movie_obj;
            });
            elemcounter = 0;
            var genre_data = $.map(Array.from(all_genres), function (genre) {
                genre_obj = {}
                if (elemcounter < 5) {
                    selected_genres.add(genre)
                    genre_obj.selected = true
                    elemcounter++;
                }
                genre_obj.id = genre;
                genre_obj.text = genre;
                return genre_obj;
            });

            $(".movie-select").select2({
                data: movie_data,
                closeOnSelect: false
            });

            $(".genre-select").select2({
                data: genre_data,
                closeOnSelect: false
            });

            initLegend()
        }

        function initLegend() {
            const legendWidth = 200;
            const legendHeight = 20;

            d3.select('.legendmain').select("svg").remove();

            const legendSVG = d3.select('.legendmain')
                .append('svg')
                .attr('viewBox', `0, 0 ${legendWidth} ${legendHeight}`);

            const width = 500;
            const height = 500;

            const legendGroups = legendSVG.selectAll('g.legend')
                .data(selected_genres.size > 0 ? selected_genres : selected_movies)
                .enter()
                .append('g')
                .attr('class', 'legend')
                .on('mouseenter', function () {
                    // expand the selected rectangle, contract every other one
                    // restore on mouseout
                    d3.selectAll('g.legend rect')
                        .transition()
                        .attr('width', 0);
                    d3.select(this)
                        .select('rect')
                        .transition()
                        .attr('x', 0)
                        .attr('width', legendWidth);
                    // introduce the text element with a small delay
                    d3.select(this)
                        .select('text')
                        .transition()
                        .delay(200)
                        .style('opacity', 1);
                })
                .on('mouseout', function () {
                    d3.selectAll('g.legend rect')
                        .transition()
                        .attr('x', (d, i) => legendWidth / (selected_genres.size > 0 ? selected_genres.size : selected_movies.size) * i)
                        .attr('width', legendWidth / (selected_genres.size > 0 ? selected_genres.size : selected_movies.size));
                    d3.select(this)
                        .select('text')
                        .transition()
                        .style('opacity', 0);
                });
            // add colored rectangles for each category
            legendGroups.append('rect')
                .attr('x', (d, i) => legendWidth / (selected_genres.size > 0 ? selected_genres.size : selected_movies.size) * i)
                .attr('y', 0)
                .attr('width', legendWidth / (selected_genres.size > 0 ? selected_genres.size : selected_movies.size))
                .attr('height', legendHeight)
                .attr('fill', (d) => colorScale(d));
            // add text elements right above the rectangle elements
            legendGroups.append('text')
                .attr('x', legendWidth / 15)
                .attr('y', legendHeight / 2)
                .text(d => { return document.getElementById('genreselect').style.display == 'block' ? d : movies[d].title })
                .attr('font-size', '0.6rem')
                .attr('fill', '#fff')
                .attr('alignment-baseline', 'middle')
                .style('pointer-events', 'none')
                .style('opacity', 0);
        }

        function applyFilters(first_load = false) {
            handleLoading(true);

            selected_movies = new Set();
            selected_genres = new Set();
            max_num_tags = document.getElementById("num_tags").value;
            range = document.getElementById('slider').value.split(',');
            filter_min_date = new Date(range[0]);
            filter_max_date = new Date(range[1]);

            if (range[0] == range[1]) {
                filter_max_date = new Date((parseFloat(range[1]) + 1).toString());
            }

            if (document.getElementById('genreselect').style.display == 'block') {
                sel_genres_obs = $('.genre-select').select2('data');
                for (let i = 0; i < sel_genres_obs.length; i++) {
                    selected_genres.add(sel_genres_obs[i].id)
                }
            } else {
                sel_movies_obs = $('.movie-select').select2('data');
                for (let i = 0; i < sel_movies_obs.length; i++) {
                    selected_movies.add(sel_movies_obs[i].id)
                }
            }
            initGlobalVariables()
            if (!first_load && (selected_genres.size != 0 || selected_movies.size != 0)) {
                draw()
            }
        }

        function handleLoading(loading) {
            if (loading) {
                document.getElementById('loadingIcon').style.display = 'block';
                document.getElementById('dataGraphs').style.display = 'none';
            } else {
                document.getElementById('loadingIcon').style.display = 'none';
                document.getElementById('dataGraphs').style.display = 'block';
            }
        }

        function draw() {
            handleLoading(true);
            d3.csv("../dataset/ratings.csv")
                .then((data) => {
                    movie_popularity = preProcessRatings(data)
                    items_ratings = preProcessItemsPopularity(movie_popularity)
                    drawScatterPlot(movie_popularity)
                    drawBoxPlot(items_ratings)
                    drawBarChart(items_ratings)
                    drawLinePlot(items_ratings, '#lineplot_num')
                    drawLinePlot(items_ratings, '#lineplot_avg')
                    d3.csv("../dataset/tags.csv")
                        .then((data) => {
                            tags = preProcessTags(data);
                            drawWordCloud(tags);
                            handleLoading(false);
                        }).catch(err => { console.log(err) });
                }).catch(err => { console.log(err) });


        }

        initGlobalVariables()

        // initial load of data that only will be executed once
        d3.csv("../dataset/movies.csv")
            .then((data) => {
                preProcessMovies(data)
                addFiltersAndLegend()
                applyFilters(true)
                draw()
            }).catch(err => { console.log(err) });

    </script>
</body>

</html>